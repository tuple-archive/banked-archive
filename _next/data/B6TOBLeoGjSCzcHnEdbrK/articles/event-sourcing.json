{"pageProps":{"page":{"id":"YU3-dRAAACEA1QHC","uid":"event-sourcing","url":null,"type":"article","href":"https://banked.cdn.prismic.io/api/v2/documents/search?ref=ZytR0hYAADAAMUe6&q=%5B%5B%3Ad+%3D+at%28document.id%2C+%22YU3-dRAAACEA1QHC%22%29+%5D%5D","tags":["technology","engineering","education","insight","developers"],"first_publication_date":"2021-09-24T16:36:14+0000","last_publication_date":"2021-09-29T16:54:17+0000","slugs":["event-sourcing."],"linked_documents":[],"lang":"en-gb","alternate_languages":[],"data":{"title":"Event Sourcing.","description":"At Banked, we offer real-time payments to our customers, which involves interfacing directly with all major UK banks. It’s important for us to know the health/service level of the APIs at each bank we interact with, so we needed a way to monitor all of that traffic.","image":{"dimensions":{"width":1392,"height":896},"alt":"payments network nebula","copyright":null,"url":"https://images.prismic.io/banked/5828a6e9-0a28-4e0c-890c-8bc5a3608f9d_dummy-img.png?auto=compress,format","id":"YUtsAhEAACEAt9El","edit":{"x":0,"y":0,"zoom":1,"background":"transparent"}},"author":{"id":"YUtfghEAACIAt5zy","type":"person","tags":[],"lang":"en-gb","slug":"tom-watt","first_publication_date":"2021-09-22T16:53:27+0000","last_publication_date":"2021-09-29T16:44:42+0000","uid":"tom-watt","data":{"full_name":"Tom Watt","role":"Payments Lead","image":{"dimensions":{"width":160,"height":160},"alt":"Tom Watt","copyright":null,"url":"https://images.prismic.io/banked/e770eb4a-b930-4a62-8b83-13c2edca8005_author-tom-watt.png?auto=compress,format","id":"YUtfaBEAACQAt5xy","edit":{"x":0,"y":0,"zoom":1,"background":"transparent"}}},"link_type":"Document","isBroken":false},"post_date":"2020-05-31","header":[],"body":[{"primary":{"text":[{"type":"heading3","text":"Event sourcing gets a mixed reaction from the development community. At Banked, we recently had a problem to solve and decided on event sourcing as an interesting solution. Our approach was one we haven’t seen elsewhere, so I thought it might be worth sharing.","spans":[{"start":0,"end":260,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Before we get to the specifics of our solution, a quick general intro to event sourcing is probably useful. If you’re familiar with all this already, you might want to skip ahead.","spans":[{"start":0,"end":179,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"heading3","text":"Event Sourcing (ES): Mini Primer.","spans":[{"start":0,"end":33,"type":"strong"}]},{"type":"paragraph","text":"The basic principle of ES is that we capture every change of state to our application as events, then store these events in the order they were produced. That log, or sequence of events, then forms our single source of truth for the state of our application.","spans":[{"start":0,"end":258,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"That’s it really.","spans":[{"start":0,"end":17,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Contrast this with the more common approach of a relational database, which will generally store the current state of the world, i.e. where we got to after all those events occurred. We actually throw away a lot of information with this approach — we know where we are, but not how we got there.","spans":[{"start":0,"end":295,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Event sourcing is not a widely used approach in software engineering (and that’s probably as it should be…) but as a general system it is more common than you might think. In fact, I can almost guarantee you use an event sourced system every single day: your bank’s ledger is an event sourced record of every change you’ve ever made to your balance. No bank would store just your current balance, and throw away the changes. Accountants had perfected event sourcing well before software engineering was around to coin the term; the first recorded ledgers were found in the city of Mesopotamia, today’s Iraq, around 7000 years ago, so its a fairly well trodden path. In the development world, the most common example of software built with ES is probably Git, and the benefits there are pretty obvious.","spans":[{"start":0,"end":801,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"That said, there’s a good reason that we all know how to use relational databases, but the same can’t be said for ES. It adds complexity, is much easier to get wrong and is arguably a more challenging paradigm for developers to operate within. For many use cases, particularly where the history of our state is irrelevant, that’s just a bad trade. For the right use case though, it’s an elegant solution.","spans":[{"start":0,"end":404,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"A lot more has been said on ES (plus associated patterns and techniques like CQRS) by people much smarter than me, so if you want to explore the fundamentals a bit more, here’s a couple of videos that could be useful if you’re interested:","spans":[{"start":0,"end":238,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Event Sourcing: you are doing it wrong — David Schmitz","spans":[{"start":0,"end":54,"type":"strong"},{"start":0,"end":54,"type":"hyperlink","data":{"link_type":"Web","url":"https://www.youtube.com/watch?v=GzrZworHpIk&t=1237s","target":"_blank"}}]},{"type":"paragraph","text":"GOTO 2014: Event Sourcing — Greg Young","spans":[{"start":0,"end":38,"type":"strong"},{"start":0,"end":38,"type":"hyperlink","data":{"link_type":"Web","url":"https://www.youtube.com/watch?v=8JKjvY4etTY","target":"_blank"}}]},{"type":"paragraph","text":"","spans":[]},{"type":"heading3","text":"Event Sourcing: Our Solution.","spans":[{"start":0,"end":29,"type":"strong"}]},{"type":"paragraph","text":"So what’s the general shape of a use case that fits? Here’s where it might make sense to get into the specifics of the problem we were trying to solve.","spans":[{"start":0,"end":151,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"At Banked, we offer real-time payments to our customers, which involves interfacing directly with all major UK banks (we’re working on the rest of Europe…). It’s important for us to know the health/service level of the APIs at each bank we interact with, so we needed a way to monitor all of that traffic. Some form of event sourcing looked like a good fit, because the question is, in essence, a temporal one, i.e. how have the responses from each API changed over time. This felt like the key to a suitable use case for ES — it has to match the reality of the world you are modelling. If that fits, everything else tends to fall into place.","spans":[{"start":0,"end":642,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"So we began to explore how we might put the theory into practice. There’s a lot of choice when it comes to the technology available. Tools like Kafka and EventStore are powerful and seem to be common choices, but the steep learning curve requires a non-trivial investment in developer time, and they also involve a reasonable commitment in ongoing maintenance. We wanted something managed, that’s quick to get going, and can be easily explained to other devs. It needs to be scalable too, because the number of events we’ll be chucking at it is significant.","spans":[{"start":0,"end":557,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Enter Google’s Firestore.","spans":[{"start":0,"end":25,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Firestore is a NoSQL document database, with a few handy features that make it a pretty great fit. The basic structure of Firestore is alternating documents and collections — with a document being a single blob of data. Each document is part of a collection alongside other documents, and each document can have sub-collections, which each contain further documents and so on, ad infinitum. Whilst a single document has a maximum size limit, the size of a collection is essentially unbounded. So this is starting to look like a good match — each of our events (a small blob of data) maps nicely to a document, and we can group these events into unbounded collections, which is ideal as the history of our application keeps growing.","spans":[{"start":0,"end":731,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"One obvious issue here is reading back the data. Given such a big collection of events, we definitely don’t want to end up searching through the whole collection to get the information we need. This is where some careful structuring of the data makes all the difference. We want to group documents together in such a way that the collection contains all the events we are interested in (but no more than that) for a given operation, and then make sure we have an index for every field we need to query. Firestore automatically sets up an index for each field in our document, so as long as we include a timestamp for each event, we get a pretty simple way to very quickly retrieve the latest N events for whichever collection we are interested in. Different problems will require their own unique structure.","spans":[{"start":0,"end":807,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Ideally, this sequence of events should also be immutable; we should never be going back and altering our history of events. This allows us to reliably recreate/replay our entire history, which is a handy feature for any software (debugging, regression testing, audit, etc.). We can do a pretty good job of ensuring this with IAM policies, although this could be improved if Google offered IAM permissions for Firestore at a more granular level, on a per-collection basis.","spans":[{"start":0,"end":472,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"So far so good.","spans":[{"start":0,"end":15,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Next we need to decide how we build our logic around Firestore. Cloud functions were an obvious choice here. Our events were already being published to PubSub, so it was simple to set up a cloud function that consumed these events and appended them to the appropriate collection in Firestore. Firestore then fires handy triggers whenever a new document is created. This allows us to hook up as many different cloud functions as we want, to listen for new events being appended, and gives us a nice way to keep each unit of work simple and self contained. Each function is responsible for calculating a given metric we are interested in, and can persist the new metric wherever we like. This also means the rest of our system needs to know nothing about event sourcing — each function can update a certain metric and push the updated information to PubSub (or wherever you like), to be consumed by any other part of the system that’s interested. So it’s totally decoupled, and doesn’t slow anyone else down if ES is not their thing. It’s also massively scalable with pretty much zero effort.","spans":[{"start":0,"end":1090,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"heading3","text":"Event Sourcing: Long Term.","spans":[{"start":0,"end":26,"type":"strong"}]},{"type":"paragraph","text":"All in all, it’s been a very successful approach so far, but there are a few pitfalls lurking down the line that require a bit of forethought to avoid. The biggest of these is versioning of events. If you are going to rely on an immutable sequence of events for your application state, you can’t just run a database migration whenever you want to change some fields around. There are a few approaches to this, but we will probably save the solution we came up with for a future blog post.","spans":[{"start":0,"end":488,"type":"strong"}]},{"type":"paragraph","text":"","spans":[]},{"type":"paragraph","text":"Eventual consistency is another common characteristic of an ES system. Again, there are a variety of solutions that ultimately depend on your use case — we were happy with eventual consistency for our particular problem, so we neatly sidestepped that one.","spans":[{"start":0,"end":255,"type":"strong"}]},{"type":"paragraph","text":"So, there you have it. At the risk of a summary full of useless platitudes: ES is not a one-size fits all pattern but, for the right situation, it can be a powerful tool. A combination of Firestore, PubSub, and Cloud Functions can be a simple and scalable implementation strategy.","spans":[{"start":0,"end":280,"type":"strong"}]},{"type":"paragraph","text":"‍","spans":[{"start":0,"end":1,"type":"strong"}]}]},"items":[{}],"id":"text$f55c80f6-425a-4b67-85d4-cd08fa64a432","slice_type":"text","slice_label":null}]}},"site":{"id":"YTigQBAAACQAaENo","uid":null,"url":null,"type":"site","href":"https://banked.cdn.prismic.io/api/v2/documents/search?ref=ZytR0hYAADAAMUe6&q=%5B%5B%3Ad+%3D+at%28document.id%2C+%22YTigQBAAACQAaENo%22%29+%5D%5D","tags":[],"first_publication_date":"2021-09-08T11:36:35+0000","last_publication_date":"2024-07-24T08:33:42+0000","slugs":["site"],"linked_documents":[],"lang":"en-gb","alternate_languages":[],"data":{"links":[{"link":{"id":"YPhIIBAAACIA2Anu","type":"page","tags":[],"lang":"en-gb","slug":"banked--real-time-payments-for-consumers-businesses-and-banks.","first_publication_date":"2021-07-21T16:15:30+0000","last_publication_date":"2023-11-14T10:26:05+0000","uid":"product","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}},"text":"Product"},{"link":{"id":"ZXoF_xIAACwAvQwL","type":"page","tags":["Use Cases"],"lang":"en-gb","slug":"banked--real-time-payments-for-consumers-businesses-and-banks.","first_publication_date":"2023-12-14T10:07:51+0000","last_publication_date":"2023-12-15T14:28:11+0000","uid":"use-cases","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}},"text":"Use Cases"},{"link":{"id":"YUm-8REAACMAsEiw","type":"page","tags":[],"lang":"en-gb","slug":"banked--real-time-payments-for-consumers-businesses-and-banks.","first_publication_date":"2021-09-21T11:17:41+0000","last_publication_date":"2023-12-15T14:23:59+0000","uid":"partners","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}},"text":"Partners"},{"link":{"id":"YUn5XREAACIAsU1B","type":"page","tags":[],"lang":"en-gb","slug":"banked--real-time-payments-for-consumers-businesses-and-banks.","first_publication_date":"2021-09-21T15:25:21+0000","last_publication_date":"2023-11-14T10:07:22+0000","uid":"consumer","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}},"text":"Consumer"},{"link":{"id":"YTijZBAAACIAaFG5","type":"articles","tags":[],"lang":"en-gb","slug":"articles","first_publication_date":"2021-09-08T11:49:58+0000","last_publication_date":"2021-10-15T15:24:45+0000","link_type":"Document","isBroken":false},"text":"Articles"}],"actions":[{"action_link":{"link_type":"Web","url":"https://console.banked.com/"},"action_text":"Log In"}],"prepend":"News","text1":"NAB and Plenti switch on PayTo for personal loan customers","action_text":"Read","action_link":{"id":"ZqC4LRMAAC4ArD_c","type":"article","tags":["pay by bank","press release","partnership","nab","APAC"],"lang":"en-gb","slug":"nab-and-plenti-switch-on-payto-solution-powered-by-banked-for-personal-loan-customers","first_publication_date":"2024-07-24T08:21:07+0000","last_publication_date":"2024-07-24T08:44:32+0000","uid":"nab-and-plenti-switch-on-payto","link_type":"Document","isBroken":false},"columns":[{"heading":"Company","text":[{"type":"paragraph","text":"About","spans":[{"start":0,"end":5,"type":"hyperlink","data":{"id":"YUpHXBEAACMAsqaB","type":"page","tags":[],"lang":"en-gb","slug":"banked--real-time-payments-for-consumers-businesses-and-banks.","first_publication_date":"2021-09-21T20:58:33+0000","last_publication_date":"2024-11-05T14:12:33+0000","uid":"about","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}}}]},{"type":"paragraph","text":"FAQs","spans":[{"start":0,"end":4,"type":"hyperlink","data":{"id":"YUmoJBEAACMAr-Eo","type":"page","tags":[],"lang":"en-gb","slug":"banked--real-time-payments-for-consumers-businesses-and-banks.","first_publication_date":"2021-09-21T09:38:50+0000","last_publication_date":"2024-07-24T08:35:51+0000","uid":"faqs","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}}}]},{"type":"paragraph","text":"Press","spans":[{"start":0,"end":5,"type":"hyperlink","data":{"id":"YgTwixIAAC8AOW74","type":"page","tags":[],"lang":"en-gb","slug":"banked--press-materials","first_publication_date":"2022-02-10T11:01:34+0000","last_publication_date":"2022-02-14T14:33:27+0000","uid":"press","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}}}]},{"type":"paragraph","text":"Contact Sales","spans":[{"start":0,"end":13,"type":"hyperlink","data":{"id":"YUn_2hEAACEAsWva","type":"page","tags":[],"lang":"en-gb","slug":"banked--real-time-payments-for-consumers-businesses-and-banks.","first_publication_date":"2021-09-21T15:53:03+0000","last_publication_date":"2023-08-08T08:57:48+0000","uid":"contact","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}}}]},{"type":"paragraph","text":"Careers","spans":[{"start":0,"end":7,"type":"hyperlink","data":{"id":"Y0a7zxEAAC4A74Vg","type":"page","tags":[],"lang":"en-gb","slug":"careers-at-banked-","first_publication_date":"2022-10-12T13:10:03+0000","last_publication_date":"2024-11-06T11:24:02+0000","uid":"careers","link_type":"Document","isBroken":false,"extras":{"ancestors":[]}}}]}]},{"heading":"Platform","text":[{"type":"paragraph","text":"Developers","spans":[{"start":0,"end":10,"type":"hyperlink","data":{"link_type":"Web","url":"https://developer.banked.com/"}}]},{"type":"paragraph","text":"Log In","spans":[{"start":0,"end":6,"type":"hyperlink","data":{"link_type":"Web","url":"https://console.banked.com/"}}]},{"type":"paragraph","text":"Status","spans":[{"start":0,"end":6,"type":"hyperlink","data":{"link_type":"Web","url":"https://status.banked.com/"}}]},{"type":"paragraph","text":"Support","spans":[{"start":0,"end":7,"type":"hyperlink","data":{"link_type":"Web","url":"https://support.paybybank.com"}}]}]},{"heading":"Community","text":[{"type":"paragraph","text":"Articles","spans":[{"start":0,"end":8,"type":"hyperlink","data":{"id":"YTijZBAAACIAaFG5","type":"articles","tags":[],"lang":"en-gb","slug":"articles","first_publication_date":"2021-09-08T11:49:58+0000","last_publication_date":"2021-10-15T15:24:45+0000","link_type":"Document","isBroken":false}}]},{"type":"paragraph","text":"LinkedIn","spans":[{"start":0,"end":8,"type":"hyperlink","data":{"link_type":"Web","url":"https://www.linkedin.com/company/banked-limited/"}}]},{"type":"paragraph","text":"Twitter","spans":[{"start":0,"end":7,"type":"hyperlink","data":{"link_type":"Web","url":"https://twitter.com/wearebanked"}}]},{"type":"paragraph","text":"Medium","spans":[{"start":0,"end":6,"type":"hyperlink","data":{"link_type":"Web","url":"https://medium.com/@banked"}}]}]},{"heading":"Legal","text":[{"type":"paragraph","text":"Privacy Policy","spans":[{"start":0,"end":14,"type":"hyperlink","data":{"link_type":"Web","url":"https://banked.com/privacy"}}]},{"type":"paragraph","text":"Terms + Conditions","spans":[{"start":0,"end":18,"type":"hyperlink","data":{"id":"YPhUnhAAACAA2D62","type":"legal","tags":[],"lang":"en-gb","slug":"pay-by-bank-payment-initiation-services-agreement.","first_publication_date":"2021-07-21T17:08:48+0000","last_publication_date":"2023-11-09T12:01:37+0000","uid":"pay-by-bank","link_type":"Document","isBroken":false}}]}]}],"footnote":[{"type":"paragraph","text":"Banked Ltd is authorised and regulated by the UK Financial Conduct Authority\n151 Wardour St, Unit 5.01, London, W1F 8WE, UK\nCompany number 11047186   :   Firm Reference Number 816944   :   +44 (0) 20 8090 2747","spans":[{"start":0,"end":209,"type":"label","data":{"label":"tag"}}]}],"text":[{"type":"paragraph","text":"We and selected partners use cookies and similar technologies as specified in the cookie policy.","spans":[{"start":0,"end":96,"type":"label","data":{"label":"p6"}},{"start":82,"end":95,"type":"hyperlink","data":{"link_type":"Web","url":"https://banked.com/cookies"}}]}],"accept":"OK","reject":"Decline","article_tags_heading":"Browse stories and categories."}}},"__N_SSG":true}